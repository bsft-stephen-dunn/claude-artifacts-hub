<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Search Artifacts - Claude Artifacts Hub</title>
  <base target="_top">
  <?!= include('stylesheet'); ?>
  <style>
    .search-filters {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 1rem;
      align-items: end;
      margin-bottom: 1.5rem;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    
    .filter-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gunmetal);
      margin-bottom: 0.25rem;
    }
    
    .search-results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .results-count {
      color: var(--slate-gray);
      font-size: 0.9rem;
    }
    
    .sort-select {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid var(--light-gray);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      color: var(--charcoal);
      backdrop-filter: blur(10px);
    }
    
    .no-results {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--slate-gray);
    }
    
    .popular-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .popular-tag {
      background: rgba(39, 144, 255, 0.1);
      color: var(--denim);
      border: 1px solid rgba(39, 144, 255, 0.2);
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .popular-tag:hover {
      background: rgba(39, 144, 255, 0.2);
      transform: translateY(-1px);
    }
    
    .clear-filters {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      border: 1px solid rgba(239, 68, 68, 0.2);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .clear-filters:hover {
      background: rgba(239, 68, 68, 0.2);
    }
    
    @media (max-width: 768px) {
      .search-filters {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .search-results-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .sort-select {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Navigation -->
    <nav class="nav">
      <a href="?" class="nav-link">üè† Home</a>
      <a href="?" class="nav-link">‚ûï Add Artifact</a>
      <a href="?page=search" class="nav-link active">üîç Search</a>
    </nav>

    <!-- Header -->
    <div class="glass-card">
      <h1>Search & Browse</h1>
      <p class="subtitle">Find the perfect artifact for your needs</p>

      <!-- Search and Filters -->
      <div class="search-filters">
        <div class="filter-group">
          <label class="filter-label" for="search-query">Search</label>
          <div class="search-container">
            <input 
              type="text" 
              id="search-query" 
              class="form-input search-input" 
              placeholder="Search by title, description, tags, or type..."
              autocomplete="off"
            >
            <span class="search-icon">üîç</span>
          </div>
        </div>
        
        <div class="filter-group">
          <label class="filter-label" for="type-filter">Type</label>
          <select id="type-filter" class="form-select">
            <option value="">All Types</option>
            <option value="HTML/CSS">HTML/CSS</option>
            <option value="JavaScript">JavaScript</option>
            <option value="React">React</option>
            <option value="Python">Python</option>
            <option value="Data Analysis">Data Analysis</option>
            <option value="Document">Document</option>
            <option value="API/Backend">API/Backend</option>
            <option value="Design">Design</option>
            <option value="Other">Other</option>
          </select>
        </div>
        
        <div class="filter-group">
          <button id="clear-filters" class="clear-filters" style="display: none;">
            Clear Filters
          </button>
        </div>
      </div>

      <!-- Popular Tags -->
      <div>
        <div class="filter-label">Popular Tags</div>
        <div class="popular-tags" id="popular-tags">
          <div class="loading">
            <div class="spinner"></div>
            Loading tags...
          </div>
        </div>
      </div>
    </div>

    <!-- Search Results -->
    <div class="glass-card">
      <div class="search-results-header">
        <div class="results-count" id="results-count">
          <div class="loading">
            <div class="spinner"></div>
            Loading artifacts...
          </div>
        </div>
        <select id="sort-select" class="sort-select">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="title">Title (A-Z)</option>
          <option value="type">Type</option>
          <option value="author">Author</option>
        </select>
      </div>

      <div id="search-results">
        <!-- Results populated here -->
      </div>
    </div>

    <!-- Search Tips -->
    <div class="glass-card">
      <h2>Search Tips</h2>
      <div style="color: var(--charcoal); line-height: 1.6;">
        <p><strong>üîç Search effectively:</strong></p>
        <ul style="margin: 0.5rem 0 1rem 1.5rem;">
          <li><strong>Keywords:</strong> Search titles, descriptions, and tags</li>
          <li><strong>Type filtering:</strong> Narrow down by artifact type</li>
          <li><strong>Tag clicking:</strong> Click popular tags for quick filtering</li>
          <li><strong>Multiple terms:</strong> Use spaces to search multiple words</li>
        </ul>
        
        <p><strong>üìä Sort options:</strong></p>
        <ul style="margin: 0.5rem 0 0 1.5rem;">
          <li><strong>Newest:</strong> See the latest contributions first</li>
          <li><strong>Title:</strong> Browse alphabetically</li>
          <li><strong>Type:</strong> Group similar artifacts together</li>
          <li><strong>Author:</strong> Find work by specific team members</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    let allArtifacts = [];
    let filteredArtifacts = [];
    let searchTimeout;

    document.addEventListener('DOMContentLoaded', function() {
      loadArtifacts();
      setupEventListeners();
    });

    function setupEventListeners() {
      const searchInput = document.getElementById('search-query');
      const typeFilter = document.getElementById('type-filter');
      const sortSelect = document.getElementById('sort-select');
      const clearFiltersBtn = document.getElementById('clear-filters');

      // Search input with debouncing
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          applyFilters();
        }, 300);
      });

      // Type filter
      typeFilter.addEventListener('change', applyFilters);

      // Sort
      sortSelect.addEventListener('change', function() {
        sortResults();
        displayResults();
      });

      // Clear filters
      clearFiltersBtn.addEventListener('click', function() {
        searchInput.value = '';
        typeFilter.value = '';
        this.style.display = 'none';
        applyFilters();
      });

      // URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const query = urlParams.get('q');
      const type = urlParams.get('type');
      
      if (query) {
        searchInput.value = query;
      }
      if (type) {
        typeFilter.value = type;
      }
    }

    function loadArtifacts() {
      google.script.run
        .withSuccessHandler(function(artifacts) {
          allArtifacts = artifacts;
          filteredArtifacts = [...artifacts];
          displayResults();
          loadPopularTags();
          
          // Apply URL filters if any
          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.get('q') || urlParams.get('type')) {
            applyFilters();
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('search-results').innerHTML = `
            <div class="alert alert-error">
              <strong>Error loading artifacts:</strong> ${error.message || 'Unknown error'}
              <br><br>
              <button onclick="loadArtifacts()" class="btn btn-secondary">Try Again</button>
            </div>
          `;
        })
        .getArtifacts();
    }

    function loadPopularTags() {
      const tagCounts = {};
      
      allArtifacts.forEach(artifact => {
        if (artifact.tags) {
          artifact.tags.split(',').forEach(tag => {
            const cleanTag = tag.trim();
            if (cleanTag) {
              tagCounts[cleanTag] = (tagCounts[cleanTag] || 0) + 1;
            }
          });
        }
      });

      const popularTags = Object.entries(tagCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([tag, count]) => ({ tag, count }));

      const tagsContainer = document.getElementById('popular-tags');
      
      if (popularTags.length === 0) {
        tagsContainer.innerHTML = '<span style="color: var(--slate-gray); font-size: 0.875rem;">No tags available yet</span>';
        return;
      }

      tagsContainer.innerHTML = popularTags.map(({ tag, count }) => 
        `<span class="popular-tag" onclick="searchByTag('${escapeHtml(tag)}')" title="${count} artifacts">
          ${escapeHtml(tag)} (${count})
        </span>`
      ).join('');
    }

    function searchByTag(tag) {
      const searchInput = document.getElementById('search-query');
      searchInput.value = tag;
      applyFilters();
    }

    function applyFilters() {
      const query = document.getElementById('search-query').value.toLowerCase().trim();
      const typeFilter = document.getElementById('type-filter').value;
      const clearBtn = document.getElementById('clear-filters');

      // Show/hide clear button
      if (query || typeFilter) {
        clearBtn.style.display = 'block';
      } else {
        clearBtn.style.display = 'none';
      }

      // Apply filters
      filteredArtifacts = allArtifacts.filter(artifact => {
        // Text search
        const matchesQuery = !query || (
          artifact.title.toLowerCase().includes(query) ||
          artifact.description.toLowerCase().includes(query) ||
          artifact.tags.toLowerCase().includes(query) ||
          artifact.type.toLowerCase().includes(query) ||
          artifact.created_by.toLowerCase().includes(query)
        );

        // Type filter
        const matchesType = !typeFilter || artifact.type === typeFilter;

        return matchesQuery && matchesType;
      });

      sortResults();
      displayResults();
      updateURL();
    }

    function sortResults() {
      const sortBy = document.getElementById('sort-select').value;
      
      filteredArtifacts.sort((a, b) => {
        switch (sortBy) {
          case 'newest':
            return new Date(b.created_date) - new Date(a.created_date);
          case 'oldest':
            return new Date(a.created_date) - new Date(b.created_date);
          case 'title':
            return a.title.localeCompare(b.title);
          case 'type':
            return a.type.localeCompare(b.type) || a.title.localeCompare(b.title);
          case 'author':
            return a.created_by.localeCompare(b.created_by) || a.title.localeCompare(b.title);
          default:
            return 0;
        }
      });
    }

    function displayResults() {
      const resultsContainer = document.getElementById('search-results');
      const resultsCount = document.getElementById('results-count');
      
      // Update count
      const total = allArtifacts.length;
      const filtered = filteredArtifacts.length;
      
      if (filtered === total) {
        resultsCount.textContent = `Showing all ${total} artifacts`;
      } else {
        resultsCount.textContent = `Showing ${filtered} of ${total} artifacts`;
      }

      // Display results
      if (filteredArtifacts.length === 0) {
        const query = document.getElementById('search-query').value;
        const typeFilter = document.getElementById('type-filter').value;
        
        resultsContainer.innerHTML = `
          <div class="no-results">
            <h3>No artifacts found</h3>
            <p>No artifacts match your current search criteria.</p>
            ${query || typeFilter ? `
              <p style="margin-top: 1rem;">
                <button onclick="document.getElementById('clear-filters').click()" class="btn btn-secondary">
                  Clear Filters
                </button>
              </p>
            ` : `
              <p style="margin-top: 1rem;">
                <a href="?page=add" class="btn btn-primary">Add First Artifact</a>
              </p>
            `}
          </div>
        `;
        return;
      }

      resultsContainer.innerHTML = filteredArtifacts.map((artifact, index) => `
        <div class="artifact-card" onclick="viewArtifact('${artifact.id}')" style="animation-delay: ${index * 0.1}s;">
          <div class="artifact-title">${escapeHtml(artifact.title)}</div>
          <div class="artifact-description">${escapeHtml(artifact.description)}</div>
          <div class="artifact-tags">
            ${artifact.tags ? artifact.tags.split(',').map(tag => 
              `<span class="tag" onclick="event.stopPropagation(); searchByTag('${escapeHtml(tag.trim())}')">${escapeHtml(tag.trim())}</span>`
            ).join('') : ''}
          </div>
          <div class="artifact-meta">
            <span class="artifact-type">${escapeHtml(artifact.type)}</span>
            <span>by ${escapeHtml(artifact.created_by)} ‚Ä¢ ${formatDate(artifact.created_date)}</span>
          </div>
        </div>
      `).join('');
    }

    function viewArtifact(id) {
      window.location.href = `?page=artifact&id=${id}`;
    }

    function updateURL() {
      const query = document.getElementById('search-query').value;
      const typeFilter = document.getElementById('type-filter').value;
      const url = new URL(window.location);
      
      // Update search params
      if (query) {
        url.searchParams.set('q', query);
      } else {
        url.searchParams.delete('q');
      }
      
      if (typeFilter) {
        url.searchParams.set('type', typeFilter);
      } else {
        url.searchParams.delete('type');
      }

      // Update URL without page reload
      window.history.replaceState({}, '', url);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffTime = Math.abs(now - date);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      if (diffDays < 30) return `${Math.ceil(diffDays / 7)} weeks ago`;
      
      return date.toLocaleDateString();
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.key === '/' && !e.ctrlKey && !e.altKey) {
        e.preventDefault();
        document.getElementById('search-query').focus();
      }
      if (e.key === 'Escape') {
        document.getElementById('search-query').blur();
      }
    });

    // Auto-focus search on load
    setTimeout(() => {
      document.getElementById('search-query').focus();
    }, 500);
  </script>
</body>
</html>