<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Artifacts Hub</title>
  <base target="_top">
  <?!= include('stylesheet'); ?>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <h1>Claude Artifacts Hub</h1>
      <p class="subtitle">Discover, share, and collaborate on Claude-generated artifacts with your team</p>
    </header>

    <!-- Navigation -->
    <nav class="nav">
      <a href="?" class="nav-link active">üè† Home</a>
      <a href="#" class="nav-link" onclick="showAddModal(); return false;">‚ûï Add Artifact</a>
      <a href="?page=search" class="nav-link">üîç Search</a>
    </nav>

    <!-- Quick Stats -->
    <div class="glass-card">
      <h2>Quick Overview</h2>
      <div id="stats-container">
        <div class="loading">
          <div class="spinner"></div>
          Loading artifacts...
        </div>
      </div>
    </div>

    <!-- Recent Artifacts -->
    <div class="glass-card">
      <h2>Recent Artifacts</h2>
      <div id="artifacts-container">
        <div class="loading">
          <div class="spinner"></div>
          Loading recent artifacts...
        </div>
      </div>
    </div>

    <!-- Getting Started -->
    <div class="glass-card">
      <h2>Getting Started</h2>
      <p>Welcome to your team's Claude Artifacts Hub! Here you can:</p>
      <ul style="margin: 1rem 0; padding-left: 1.5rem; color: var(--charcoal);">
        <li>üìù <strong>Share artifacts</strong> - Upload and organize Claude-generated content</li>
        <li>üîç <strong>Discover work</strong> - Find artifacts created by your teammates</li>
        <li>üè∑Ô∏è <strong>Organize with tags</strong> - Categorize artifacts for easy discovery</li>
        <li>üí¨ <strong>Collaborate</strong> - Build upon each other's work</li>
      </ul>
      <a href="#" class="btn btn-primary" onclick="showAddModal(); return false;">Add Your First Artifact</a>
    </div>
  </div>

  <!-- Add Artifact Modal -->
  <div id="add-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add HTML Artifact</h2>
        <span class="modal-close" onclick="hideAddModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="add-artifact-form">
          <div class="form-group">
            <label for="artifact-title" class="form-label">Title <span class="required">*</span></label>
            <input 
              type="text" 
              id="artifact-title" 
              class="form-input" 
              placeholder="Give your artifact a descriptive title"
              required
            >
          </div>
          
          <div class="form-group">
            <label for="artifact-description" class="form-label">Description</label>
            <input 
              type="text" 
              id="artifact-description" 
              class="form-input" 
              placeholder="Brief description (optional)"
            >
          </div>
          
          <div class="form-group">
            <label for="artifact-html" class="form-label">HTML Content <span class="required">*</span></label>
            <textarea 
              id="artifact-html" 
              class="form-textarea" 
              rows="10"
              placeholder="Paste your HTML content here..."
              required
              style="font-family: 'Courier New', monospace; font-size: 0.875rem;"
            ></textarea>
          </div>
          
          <div class="form-group">
            <label for="artifact-tags" class="form-label">Tags</label>
            <input 
              type="text" 
              id="artifact-tags" 
              class="form-input" 
              placeholder="Comma-separated tags (e.g., dashboard, visualization, component)"
            >
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="submit-btn">
              <span id="submit-text">Add Artifact</span>
              <span id="submit-loading" style="display: none;">
                <div class="spinner" style="display: inline-block; width: 16px; height: 16px;"></div>
                Adding...
              </span>
            </button>
            <button type="button" class="btn btn-secondary" onclick="hideAddModal()">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Load artifacts on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadArtifacts();
      loadStats();
      setupModalHandlers();
    });

    function loadArtifacts() {
      google.script.run
        .withSuccessHandler(displayArtifacts)
        .withFailureHandler(handleError)
        .getArtifacts();
    }

    function loadStats() {
      google.script.run
        .withSuccessHandler(displayStats)
        .withFailureHandler(handleStatsError)
        .getArtifacts();
    }

    function displayStats(artifacts) {
      const statsContainer = document.getElementById('stats-container');
      const totalArtifacts = artifacts.length;
      const uniqueAuthors = new Set(artifacts.map(a => a.created_by)).size;
      const recentArtifacts = artifacts.filter(a => {
        const createdDate = new Date(a.created_date);
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        return createdDate > weekAgo;
      }).length;

      const typeCount = artifacts.reduce((acc, artifact) => {
        acc[artifact.type] = (acc[artifact.type] || 0) + 1;
        return acc;
      }, {});

      const mostPopularType = Object.keys(typeCount).reduce((a, b) => 
        typeCount[a] > typeCount[b] ? a : b, 'N/A');

      statsContainer.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; text-align: center;">
          <div>
            <div style="font-size: 2rem; font-weight: 700; color: var(--dodger-blue);">${totalArtifacts}</div>
            <div style="color: var(--slate-gray); font-size: 0.9rem;">Total Artifacts</div>
          </div>
          <div>
            <div style="font-size: 2rem; font-weight: 700; color: var(--electric-violet);">${uniqueAuthors}</div>
            <div style="color: var(--slate-gray); font-size: 0.9rem;">Contributors</div>
          </div>
          <div>
            <div style="font-size: 2rem; font-weight: 700; color: var(--ultramarine);">${recentArtifacts}</div>
            <div style="color: var(--slate-gray); font-size: 0.9rem;">This Week</div>
          </div>
          <div>
            <div style="font-size: 1.2rem; font-weight: 600; color: var(--denim);">${mostPopularType}</div>
            <div style="color: var(--slate-gray); font-size: 0.9rem;">Popular Type</div>
          </div>
        </div>
      `;
    }

    function handleStatsError(error) {
      const statsContainer = document.getElementById('stats-container');
      statsContainer.innerHTML = `
        <div class="alert alert-error">
          Unable to load statistics. Please refresh the page.
        </div>
      `;
    }

    function displayArtifacts(artifacts) {
      const container = document.getElementById('artifacts-container');
      
      if (artifacts.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: var(--slate-gray);">
            <h3>No artifacts yet</h3>
            <p>Be the first to share a Claude artifact with your team!</p>
            <a href="#" class="btn btn-primary" style="margin-top: 1rem;" onclick="showAddModal(); return false;">Add First Artifact</a>
          </div>
        `;
        return;
      }

      // Show most recent 6 artifacts
      const recentArtifacts = artifacts.slice(0, 6);
      
      container.innerHTML = recentArtifacts.map(artifact => `
        <div class="artifact-card" onclick="viewArtifact('${artifact.id}')">
          <div class="artifact-title">${escapeHtml(artifact.title)}</div>
          <div class="artifact-description">${escapeHtml(artifact.description)}</div>
          <div class="artifact-tags">
            ${artifact.tags ? artifact.tags.split(',').map(tag => 
              `<span class="tag">${escapeHtml(tag.trim())}</span>`
            ).join('') : ''}
          </div>
          <div class="artifact-meta">
            <span class="artifact-type">${escapeHtml(artifact.type)}</span>
            <span>by ${escapeHtml(artifact.created_by)} ‚Ä¢ ${formatDate(artifact.created_date)}</span>
          </div>
        </div>
      `).join('');

      if (artifacts.length > 6) {
        container.innerHTML += `
          <div style="text-align: center; margin-top: 1rem;">
            <a href="?page=search" class="btn btn-secondary">View All ${artifacts.length} Artifacts</a>
          </div>
        `;
      }
    }

    function handleError(error) {
      const container = document.getElementById('artifacts-container');
      container.innerHTML = `
        <div class="alert alert-error">
          <strong>Error loading artifacts:</strong> ${error.message || 'Unknown error occurred'}
          <br><br>
          <button onclick="loadArtifacts()" class="btn btn-secondary">Try Again</button>
        </div>
      `;
    }

    function viewArtifact(id) {
      window.location.href = `?page=artifact&id=${id}`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffTime = Math.abs(now - date);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      if (diffDays < 30) return `${Math.ceil(diffDays / 7)} weeks ago`;
      
      return date.toLocaleDateString();
    }

    // Add keyboard navigation
    document.addEventListener('keydown', function(e) {
      if (e.key === 'a' && e.ctrlKey) {
        e.preventDefault();
        showAddModal();
      }
      if (e.key === 's' && e.ctrlKey) {
        e.preventDefault();
        window.location.href = '?page=search';
      }
    });

    // Modal functions
    function showAddModal() {
      const modal = document.getElementById('add-modal');
      modal.style.display = 'flex';
      document.getElementById('artifact-title').focus();
    }

    function hideAddModal() {
      const modal = document.getElementById('add-modal');
      modal.style.display = 'none';
      document.getElementById('add-artifact-form').reset();
    }

    function setupModalHandlers() {
      const form = document.getElementById('add-artifact-form');
      const modal = document.getElementById('add-modal');
      
      // Form submission
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
          title: document.getElementById('artifact-title').value.trim(),
          description: document.getElementById('artifact-description').value.trim() || 'HTML Artifact',
          type: 'HTML',
          content: document.getElementById('artifact-html').value.trim(),
          tags: document.getElementById('artifact-tags').value.trim()
        };
        
        // Show loading state
        const submitBtn = document.getElementById('submit-btn');
        const submitText = document.getElementById('submit-text');
        const submitLoading = document.getElementById('submit-loading');
        
        submitBtn.disabled = true;
        submitText.style.display = 'none';
        submitLoading.style.display = 'inline';
        
        // Submit to Google Apps Script
        google.script.run
          .withSuccessHandler(handleAddSuccess)
          .withFailureHandler(handleAddError)
          .addArtifact(formData);
      });
      
      // Click outside modal to close
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          hideAddModal();
        }
      });
      
      // Escape key to close
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
          hideAddModal();
        }
      });
    }

    function handleAddSuccess(result) {
      if (result.success) {
        hideAddModal();
        showNotification('Artifact added successfully!', 'success');
        loadArtifacts(); // Reload artifacts
        loadStats(); // Reload stats
      } else {
        handleAddError(result.error || 'Failed to add artifact');
      }
    }

    function handleAddError(error) {
      // Reset button state
      const submitBtn = document.getElementById('submit-btn');
      const submitText = document.getElementById('submit-text');
      const submitLoading = document.getElementById('submit-loading');
      
      submitBtn.disabled = false;
      submitText.style.display = 'inline';
      submitLoading.style.display = 'none';
      
      showNotification(`Error: ${error.message || error}`, 'error');
    }

    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = `alert alert-${type}`;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        max-width: 400px;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
      `;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }
  </script>

  <style>
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlideIn 0.3s ease-out;
    }
    
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h2 {
      margin: 0;
      color: var(--charcoal);
    }
    
    .modal-close {
      font-size: 2rem;
      color: var(--slate-gray);
      cursor: pointer;
      line-height: 1;
      transition: color 0.3s ease;
    }
    
    .modal-close:hover {
      color: var(--charcoal);
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--gunmetal);
    }
    
    .required {
      color: #ef4444;
    }
    
    .form-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid var(--light-gray);
    }
    
    @keyframes modalSlideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
  </style>
</body>
</html>