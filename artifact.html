<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Artifact Details - Claude Artifacts Hub</title>
  <base target="_top">
  <?!= include('stylesheet'); ?>
  <style>
    .code-block {
      background: #1e1e1e;
      color: #d4d4d4;
      border-radius: var(--border-radius-button);
      padding: 1.5rem;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 0.875rem;
      line-height: 1.5;
      overflow-x: auto;
      white-space: pre;
      position: relative;
      margin: 1rem 0;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .copy-btn {
      background: rgba(39, 144, 255, 0.1);
      color: var(--dodger-blue);
      border: 1px solid rgba(39, 144, 255, 0.3);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .copy-btn:hover {
      background: rgba(39, 144, 255, 0.2);
      transform: translateY(-1px);
    }
    
    .copy-btn.copied {
      background: rgba(34, 197, 94, 0.1);
      color: #059669;
      border-color: rgba(34, 197, 94, 0.3);
    }
    
    .artifact-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin: 1.5rem 0;
    }
    
    .artifact-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1.5rem;
      gap: 1rem;
    }
    
    .artifact-info {
      flex: 1;
    }
    
    .artifact-meta-full {
      background: rgba(255, 255, 255, 0.5);
      padding: 1rem;
      border-radius: var(--border-radius-button);
      margin: 1rem 0;
      backdrop-filter: blur(10px);
    }
    
    .meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .meta-row:last-child {
      border-bottom: none;
    }
    
    .meta-label {
      font-weight: 600;
      color: var(--gunmetal);
      font-size: 0.9rem;
    }
    
    .meta-value {
      color: var(--charcoal);
      text-align: right;
      font-size: 0.9rem;
    }
    
    @media (max-width: 768px) {
      .artifact-header {
        flex-direction: column;
      }
      
      .artifact-actions {
        flex-direction: column;
      }
      
      .code-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .meta-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
      }
      
      .meta-value {
        text-align: left;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Navigation -->
    <nav class="nav">
      <a href="?" class="nav-link">üè† Home</a>
      <a href="?" class="nav-link">‚ûï Add Artifact</a>
      <a href="?page=search" class="nav-link">üîç Search</a>
    </nav>

    <!-- Loading State -->
    <div id="loading-container" class="glass-card">
      <div class="loading">
        <div class="spinner"></div>
        Loading artifact details...
      </div>
    </div>

    <!-- Error State -->
    <div id="error-container" class="glass-card" style="display: none;">
      <div class="alert alert-error">
        <strong>Artifact not found</strong><br>
        The requested artifact doesn't exist or may have been removed.
        <br><br>
        <a href="?" class="btn btn-secondary">Back to Home</a>
      </div>
    </div>

    <!-- Artifact Content -->
    <div id="artifact-content" style="display: none;">
      <!-- Header -->
      <div class="glass-card">
        <div class="artifact-header">
          <div class="artifact-info">
            <h1 id="artifact-title">Loading...</h1>
            <p id="artifact-description" class="subtitle">Loading description...</p>
            <div id="artifact-tags" class="artifact-tags"></div>
          </div>
        </div>
        
        <div class="artifact-actions">
          <button id="copy-all-btn" class="btn btn-primary">
            üìã Copy All Code
          </button>
          <button id="download-btn" class="btn btn-secondary">
            üíæ Download
          </button>
          <button id="delete-btn" class="btn btn-secondary" style="background: linear-gradient(135deg, #dc2626, #b91c1c); display: none;">
            üóëÔ∏è Delete
          </button>
        </div>
      </div>

      <!-- Metadata -->
      <div class="glass-card">
        <h2>Details</h2>
        <div class="artifact-meta-full" id="artifact-metadata">
          <!-- Populated by JavaScript -->
        </div>
      </div>

      <!-- HTML Preview (for HTML artifacts) -->
      <div class="glass-card" id="preview-section" style="display: none;">
        <h2>Preview</h2>
        <div style="background: white; border-radius: 8px; padding: 1rem; margin: 1rem 0; min-height: 300px;">
          <iframe id="preview-iframe" style="width: 100%; min-height: 400px; border: none; border-radius: 8px;"></iframe>
        </div>
      </div>

      <!-- Code Content -->
      <div class="glass-card">
        <div class="code-header">
          <h2>HTML Code</h2>
          <button id="copy-code-btn" class="copy-btn">
            üìã Copy Code
          </button>
        </div>
        <div class="code-block" id="code-content">
          <!-- Populated by JavaScript -->
        </div>
      </div>

      <!-- Usage Instructions -->
      <div class="glass-card">
        <h2>How to Use</h2>
        <div id="usage-instructions">
          <p>To use this artifact:</p>
          <ol style="margin: 1rem 0; padding-left: 1.5rem; color: var(--charcoal); line-height: 1.6;">
            <li>Copy the code using the button above</li>
            <li>Create a new conversation with Claude</li>
            <li>Paste the code and ask Claude to explain or modify it</li>
            <li>For web artifacts, save as an HTML file and open in your browser</li>
          </ol>
          <p style="color: var(--slate-gray); font-size: 0.9rem; margin-top: 1rem;">
            üí° <strong>Tip:</strong> You can ask Claude to modify this artifact, add features, or adapt it for your specific needs.
          </p>
        </div>
      </div>

      <!-- Related Artifacts -->
      <div class="glass-card" id="related-artifacts" style="display: none;">
        <h2>Related Artifacts</h2>
        <div id="related-content">
          <!-- Populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <script>
    const artifactId = '<?= artifactId ?>';
    let currentArtifact = null;

    document.addEventListener('DOMContentLoaded', function() {
      if (artifactId) {
        loadArtifact(artifactId);
      } else {
        showError();
      }
    });

    function loadArtifact(id) {
      google.script.run
        .withSuccessHandler(displayArtifact)
        .withFailureHandler(showError)
        .getArtifact(id);
    }

    function displayArtifact(artifact) {
      const loadingContainer = document.getElementById('loading-container');
      const errorContainer = document.getElementById('error-container');
      const artifactContent = document.getElementById('artifact-content');

      if (!artifact) {
        showError();
        return;
      }

      currentArtifact = artifact;

      // Hide loading, show content
      loadingContainer.style.display = 'none';
      errorContainer.style.display = 'none';
      artifactContent.style.display = 'block';

      // Populate content
      document.getElementById('artifact-title').textContent = artifact.title;
      document.getElementById('artifact-description').textContent = artifact.description;
      document.title = `${artifact.title} - Claude Artifacts Hub`;

      // Tags
      const tagsContainer = document.getElementById('artifact-tags');
      if (artifact.tags) {
        tagsContainer.innerHTML = artifact.tags.split(',').map(tag => 
          `<span class="tag">${escapeHtml(tag.trim())}</span>`
        ).join('');
      } else {
        tagsContainer.innerHTML = '';
      }

      // Metadata
      const metadataContainer = document.getElementById('artifact-metadata');
      metadataContainer.innerHTML = `
        <div class="meta-row">
          <span class="meta-label">Type</span>
          <span class="meta-value">${escapeHtml(artifact.type)}</span>
        </div>
        <div class="meta-row">
          <span class="meta-label">Created by</span>
          <span class="meta-value">${escapeHtml(artifact.created_by)}</span>
        </div>
        <div class="meta-row">
          <span class="meta-label">Created</span>
          <span class="meta-value">${formatDate(artifact.created_date)}</span>
        </div>
        <div class="meta-row">
          <span class="meta-label">Last updated</span>
          <span class="meta-value">${formatDate(artifact.updated_date)}</span>
        </div>
        <div class="meta-row">
          <span class="meta-label">Content size</span>
          <span class="meta-value">${formatFileSize(artifact.content.length)}</span>
        </div>
      `;

      // Code content
      const codeContainer = document.getElementById('code-content');
      codeContainer.textContent = artifact.content;

      // Show HTML preview if artifact type is HTML
      if (artifact.type === 'HTML') {
        const previewSection = document.getElementById('preview-section');
        const previewIframe = document.getElementById('preview-iframe');
        previewSection.style.display = 'block';
        
        // Set iframe content
        const iframeDoc = previewIframe.contentDocument || previewIframe.contentWindow.document;
        iframeDoc.open();
        iframeDoc.write(artifact.content);
        iframeDoc.close();
        
        // Auto-resize iframe
        setTimeout(() => {
          try {
            const height = iframeDoc.body.scrollHeight;
            previewIframe.style.height = Math.max(400, height + 40) + 'px';
          } catch (e) {
            // Cross-origin or other errors, keep default height
          }
        }, 100);
      }

      // Show delete button if user is the creator
      checkUserPermissions(artifact);

      // Load related artifacts
      loadRelatedArtifacts(artifact);

      // Add event listeners
      setupEventListeners();
    }

    function showError() {
      const loadingContainer = document.getElementById('loading-container');
      const errorContainer = document.getElementById('error-container');
      const artifactContent = document.getElementById('artifact-content');

      loadingContainer.style.display = 'none';
      errorContainer.style.display = 'block';
      artifactContent.style.display = 'none';
    }

    function setupEventListeners() {
      // Copy all code
      document.getElementById('copy-all-btn').addEventListener('click', function() {
        copyToClipboard(currentArtifact.content, this);
      });

      // Copy code block
      document.getElementById('copy-code-btn').addEventListener('click', function() {
        copyToClipboard(currentArtifact.content, this);
      });

      // Download
      document.getElementById('download-btn').addEventListener('click', function() {
        downloadArtifact(currentArtifact);
      });

      // Delete (if visible)
      const deleteBtn = document.getElementById('delete-btn');
      if (deleteBtn.style.display !== 'none') {
        deleteBtn.addEventListener('click', function() {
          if (confirm('Are you sure you want to delete this artifact? This action cannot be undone.')) {
            deleteArtifact(currentArtifact.id);
          }
        });
      }
    }

    function copyToClipboard(text, button) {
      navigator.clipboard.writeText(text).then(function() {
        const originalText = button.textContent;
        button.textContent = '‚úÖ Copied!';
        button.classList.add('copied');
        
        setTimeout(function() {
          button.textContent = originalText;
          button.classList.remove('copied');
        }, 2000);
      }).catch(function(err) {
        console.error('Failed to copy: ', err);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        button.textContent = '‚úÖ Copied!';
        setTimeout(function() {
          button.textContent = 'üìã Copy Code';
        }, 2000);
      });
    }

    function downloadArtifact(artifact) {
      const extension = getFileExtension(artifact.type);
      const filename = `${sanitizeFilename(artifact.title)}.${extension}`;
      const blob = new Blob([artifact.content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function getFileExtension(type) {
      const extensions = {
        'HTML': 'html',
        'HTML/CSS': 'html',
        'JavaScript': 'js',
        'React': 'jsx',
        'Python': 'py',
        'Data Analysis': 'py',
        'Document': 'md',
        'API/Backend': 'js',
        'Design': 'html',
        'Other': 'txt'
      };
      return extensions[type] || 'txt';
    }

    function sanitizeFilename(name) {
      return name.replace(/[^a-zA-Z0-9\s-_]/g, '').replace(/\s+/g, '_').toLowerCase();
    }

    function checkUserPermissions(artifact) {
      // In a real implementation, you'd check if the current user is the creator
      // For now, we'll show the delete button for demonstration
      // You could call a server function to check permissions
      google.script.run
        .withSuccessHandler(function(userEmail) {
          if (userEmail === artifact.created_by) {
            document.getElementById('delete-btn').style.display = 'inline-flex';
          }
        })
        .withFailureHandler(function() {
          // Hide delete button on error
        })
        .Session.getActiveUser().getEmail();
    }

    function deleteArtifact(id) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            alert('Artifact deleted successfully!');
            window.location.href = '?';
          } else {
            alert('Failed to delete artifact: ' + result.error);
          }
        })
        .withFailureHandler(function(error) {
          alert('Error deleting artifact: ' + error);
        })
        .deleteArtifact(id);
    }

    function loadRelatedArtifacts(artifact) {
      // Load artifacts with similar tags or type
      google.script.run
        .withSuccessHandler(function(artifacts) {
          const related = artifacts
            .filter(a => a.id !== artifact.id)
            .filter(a => a.type === artifact.type || hasCommonTags(a.tags, artifact.tags))
            .slice(0, 3);

          if (related.length > 0) {
            displayRelatedArtifacts(related);
          }
        })
        .withFailureHandler(function() {
          // Hide related section on error
        })
        .getArtifacts();
    }

    function hasCommonTags(tags1, tags2) {
      if (!tags1 || !tags2) return false;
      const set1 = new Set(tags1.split(',').map(t => t.trim().toLowerCase()));
      const set2 = new Set(tags2.split(',').map(t => t.trim().toLowerCase()));
      return [...set1].some(tag => set2.has(tag));
    }

    function displayRelatedArtifacts(artifacts) {
      const relatedContainer = document.getElementById('related-artifacts');
      const relatedContent = document.getElementById('related-content');
      
      relatedContent.innerHTML = artifacts.map(artifact => `
        <div class="artifact-card" onclick="window.location.href='?page=artifact&id=${artifact.id}'">
          <div class="artifact-title">${escapeHtml(artifact.title)}</div>
          <div class="artifact-description">${escapeHtml(artifact.description)}</div>
          <div class="artifact-meta">
            <span class="artifact-type">${escapeHtml(artifact.type)}</span>
            <span>by ${escapeHtml(artifact.created_by)}</span>
          </div>
        </div>
      `).join('');
      
      relatedContainer.style.display = 'block';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.key === 'c' && e.ctrlKey) {
        e.preventDefault();
        if (currentArtifact) {
          copyToClipboard(currentArtifact.content, document.getElementById('copy-all-btn'));
        }
      }
      if (e.key === 'd' && e.ctrlKey) {
        e.preventDefault();
        if (currentArtifact) {
          downloadArtifact(currentArtifact);
        }
      }
      if (e.key === 'Escape') {
        window.location.href = '?';
      }
    });
  </script>
</body>
</html>